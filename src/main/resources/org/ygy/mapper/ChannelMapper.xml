<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
    
<mapper namespace="org.ygy.mapper.ChannelMapper">

	<resultMap type="org.ygy.entity.ChannelEntity" id="channelMapper">
		<result column="channel_id" property="id"/>
		<result column="channel_show_name" property="name"/>
		<result column="channel_show_url" property="url"/>
		<result column="channel_type" property="type"></result>
	</resultMap>
	
	<resultMap type="org.ygy.entity.easyui.ESColumn" id="esColumnMapper">
		<result column="field" property="field"></result>
		<result column="title" property="title"></result>
	</resultMap>
	
	<resultMap type="org.ygy.vo.ChannelInfoVO" id="channelInfoMapper">
		<result column="channel_id" property="id"/>
		<result column="channel_show_name" property="showName"/>
		<result column="channel_show_url" property="showURL"/>
		<result column="calendar_id" property="calendarId"/>
		<result column="cust_register_num" property="registerNum"/>
		<result column="cust_register_num_total" property="totalNum"/>				
	</resultMap>
  
  	<select id="selectChannels" resultMap="channelMapper" parameterType="org.ygy.entity.PageSearch">
		select 
			tm_channel.channel_id,
			tm_channel.channel_show_name,
			tm_channel.channel_show_url
		from 
			dr_bi.v_dim_channel tm_channel
		left join 
			dr_bi.dm_cust_channel_analyse tm_cus
		on 
			tm_cus.channel_id = tm_channel.channel_id
		<where> 
			tm_cus.calendar_id =  (
				select max(calendar_id) from dr_bi.dm_cust_channel_analyse
				<where>
					<if	test="startDate != null and startDate != ''">
						date(calendar_id) >= date(#{startDate})
					</if>
					<if test="endDate != null and endDate != ''">
						<![CDATA[
						and date(calendar_id) < date(#{endDate})
						]]>
					</if>			
				</where>
			)
			<if test="channelType != null and channelType != ''">
				and tm_channel.channel_type = #{channelType}
			</if>
		</where>	
		order by 
			tm_cus.cust_register_num desc,
			tm_channel.channel_id desc 
  	</select>
  	
  	<select id="selectColumns" resultMap="esColumnMapper" parameterType="org.ygy.entity.PageSearch">
		select 
			calendar_id field,
			date_format(calendar_id,'%m月%d日') title
		from 
			dr_bi.dm_cust_channel_analyse
		<where>
			<if	test="startDate != null and startDate != ''">
				date(calendar_id) >= date(#{startDate})
			</if>
			<if test="endDate != null and endDate != ''">
				<![CDATA[
				and date(calendar_id) < date(#{endDate})
				]]>
			</if>
		</where> 
		group by 
			calendar_id,
			date_format(calendar_id,'%m月%d日')
		order by 
			calendar_id desc
  	</select>
  	
  	<select id="selectChannelInfo" resultMap="channelInfoMapper" parameterType="org.ygy.entity.PageSearch">
	  	select 
			tm_channel.channel_id,
			tm_channel.channel_show_name,
			tm_channel.channel_show_url,
			tm_cus.calendar_id,
			coalesce(tm_cus.cust_register_num,0) cust_register_num,
			coalesce(tm_cus.cust_register_num_total,0) cust_register_num_total
		from 
			dr_bi.v_dim_channel tm_channel
		left join 
			dr_bi.dm_cust_channel_analyse tm_cus
		on 
			tm_cus.channel_id = tm_channel.channel_id
		<where>
			<if test="channelId != null">
				tm_channel.channel_id = #{channelId}
			</if>
			<if test="startDate != null and startDate != ''">
				and  date(tm_cus.calendar_id) >= date(#{startDate}) 
			</if>
			<if test="endDate != null and endDate != ''">
			  	<![CDATA[
				and  date(tm_cus.calendar_id) < date(#{endDate}) 
				]]>
			</if>			
		</where>
		group by 
			tm_channel.channel_id,
			tm_channel.channel_show_name,
			tm_channel.channel_show_url,			
			tm_cus.calendar_id
		order by 
			tm_cus.cust_register_num desc,
			tm_cus.calendar_id desc
  	</select>
  	
  	
  	<select id="selectChannelType" resultMap="channelMapper">
		select 
			channel_type channel_type
		from 
			dr_bi.v_dim_channel
		where 
			channel_type is not null
		group by 
			channel_type
  	</select>
    
</mapper> 